@model OrderPaginatedResult<OrderDto>
@{
    Layout = "_AdminLayout";
    ViewData["Title"] = "Orders";
}

@functions {
    private string GetOrdering()
        => (Model.SortOrder == Sorting.Ascending|| Model.SortOrder == "") ? Sorting.Descending : Sorting.Ascending;
    
    private bool IsStatusSelected(int statusValue)
        => Model.Status.HasValue && Model.Status.Value == statusValue;
}

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="mb-4">Orders</h1>
</div>

@* Page Size Selector *@
@await Html.PartialAsync("_PageSizeSelectorPartial", model: @Model.PageSize)

@* Filter and Search Form *@
<form method="get" asp-action="Index"
      class="d-flex justify-content-between align-items-center flex-wrap my-3">

    @* Status Filter - Left Side *@
    <div class="input-group input-group-md" style="width: auto">
        <label for="statusFilter" class="form-label me-2 mb-0 d-flex align-items-center">
            <i class="bi bi-funnel me-1"></i>
            <span class="fw-semibold">Filter by Status:</span>
        </label>
        <select id="statusFilter" name="status" class="form-select m-1"
                style="border-radius:20px; min-width: 150px;"
                onchange="this.form.submit()">
            <option value="">All Statuses</option>
            <option value="1" selected="@IsStatusSelected(1)">Processing</option>
            <option value="2" selected="@IsStatusSelected(2)">Paid</option>
            <option value="3" selected="@IsStatusSelected(3)">Cancelled</option>
            <option value="4" selected="@IsStatusSelected(4)">Failed</option>
        </select>
    </div>

    @* Search Form - Right Side *@
    <div class="input-group input-group-md" style="width: auto">
        <select asp-for="SearchBy" class="form-select m-1"
                style="border-radius:20px; min-width: 150px;">
            <option value="Id">Id</option>
            <option value="OrderNumber">Order Number</option>
            <option value="SubTotal">Sub Total</option>
            <option value="Total">Total</option>
            <option value="Shipping">Shipping</option>
            <option value="Discount">Discount</option>
            <option value="Currency">Currency</option>
        </select>

        <input asp-for="SearchValue" type="text" class="form-control me-1 rounded-pill m-1"
               placeholder="Search" style="min-width: 200px;">

        <button type="submit" class="btn btn-outline-success rounded-pill m-1">
            Search
        </button>
    </div>

    <!-- hidden fields -->
    <input type="hidden" name="pageNumber" value="1"/>
    <input type="hidden" name="pageSize" value="@Model.PageSize"/>
    <input type="hidden" name="sortBy" value="@Model.SortBy"/>
    <input type="hidden" name="sortOrder" value="@Model.SortOrder"/>
</form>

<div class="table-responsive">
    <table class="table table-bordered table-hover">
        <thead class="table-light">
        <tr>
            <th>
                <a
                    asp-action="Index"
                    asp-route-pageNumber="@Model.PageNumber"
                    asp-route-pageSize="@Model.PageSize"
                    asp-route-sortBy="Id"
                    asp-route-sortOrder=@GetOrdering()
                    asp-route-searchBy="@Model.SearchBy"
                    asp-route-searchValue="@Model.SearchValue"
                    asp-route-status="@Model.Status"
                    class="link-underline text-decoration-none">
                    <i class="bi bi-funnel-fill"></i> ID
                </a>
            </th>
            <th>
                <a
                    asp-action="Index"
                    asp-route-pageNumber="@Model.PageNumber"
                    asp-route-pageSize="@Model.PageSize"
                    asp-route-sortBy="OrderNumber"
                    asp-route-sortOrder=@GetOrdering()
                    asp-route-searchBy="@Model.SearchBy"
                    asp-route-searchValue="@Model.SearchValue"
                    asp-route-status="@Model.Status"
                    class="link-underline text-decoration-none">
                    <i class="bi bi-funnel-fill"></i> Order Number
                </a>
            </th>
            <th>
                <a
                    asp-action="Index"
                    asp-route-pageNumber="@Model.PageNumber"
                    asp-route-pageSize="@Model.PageSize"
                    asp-route-sortBy="Status"
                    asp-route-sortOrder=@GetOrdering()
                    asp-route-searchBy="@Model.SearchBy"
                    asp-route-searchValue="@Model.SearchValue"
                    asp-route-status="@Model.Status"
                    class="link-underline text-decoration-none">
                    <i class="bi bi-funnel-fill"></i> Status
                </a>
            </th>
            <th>
                <a
                    asp-action="Index"
                    asp-route-pageNumber="@Model.PageNumber"
                    asp-route-pageSize="@Model.PageSize"
                    asp-route-sortBy="SubTotal"
                    asp-route-sortOrder=@GetOrdering()
                    asp-route-searchBy="@Model.SearchBy"
                    asp-route-searchValue="@Model.SearchValue"
                    asp-route-status="@Model.Status"
                    class="link-underline text-decoration-none">
                    <i class="bi bi-funnel-fill"></i> SubTotal
                </a>
            </th>
            <th>
                <a
                    asp-action="Index"
                    asp-route-pageNumber="@Model.PageNumber"
                    asp-route-pageSize="@Model.PageSize"
                    asp-route-sortBy="Shipping"
                    asp-route-sortOrder=@GetOrdering()
                    asp-route-searchBy="@Model.SearchBy"
                    asp-route-searchValue="@Model.SearchValue"
                    asp-route-status="@Model.Status"
                    class="link-underline text-decoration-none">
                    <i class="bi bi-funnel-fill"></i> Shipping
                </a>
            </th>
            <th>
                <a
                    asp-action="Index"
                    asp-route-pageNumber="@Model.PageNumber"
                    asp-route-pageSize="@Model.PageSize"
                    asp-route-sortBy="Discount"
                    asp-route-sortOrder=@GetOrdering()
                    asp-route-searchBy="@Model.SearchBy"
                    asp-route-searchValue="@Model.SearchValue"
                    asp-route-status="@Model.Status"
                    class="link-underline text-decoration-none">
                    <i class="bi bi-funnel-fill"></i> Discount
                </a>
            </th>
            <th>
                <a
                    asp-action="Index"
                    asp-route-pageNumber="@Model.PageNumber"
                    asp-route-pageSize="@Model.PageSize"
                    asp-route-sortBy="Total"
                    asp-route-sortOrder=@GetOrdering()
                    asp-route-searchBy="@Model.SearchBy"
                    asp-route-searchValue="@Model.SearchValue"
                    asp-route-status="@Model.Status"
                    class="link-underline text-decoration-none">
                    <i class="bi bi-funnel-fill"></i> Total
                </a>
            </th>
            <th>
                <a
                    asp-action="Index"
                    asp-route-pageNumber="@Model.PageNumber"
                    asp-route-pageSize="@Model.PageSize"
                    asp-route-sortBy="Currency"
                    asp-route-sortOrder=@GetOrdering()
                    asp-route-searchBy="@Model.SearchBy"
                    asp-route-searchValue="@Model.SearchValue"
                    asp-route-status="@Model.Status"
                    class="link-underline text-decoration-none">
                    <i class="bi bi-funnel-fill"></i> Currency
                </a>
            </th>
            <th>
                <a
                    asp-action="Index"
                    asp-route-pageNumber="@Model.PageNumber"
                    asp-route-pageSize="@Model.PageSize"
                    asp-route-sortBy="IsPaid"
                    asp-route-sortOrder=@GetOrdering()
                    asp-route-searchBy="@Model.SearchBy"
                    asp-route-searchValue="@Model.SearchValue"
                    asp-route-status="@Model.Status"
                    class="link-underline text-decoration-none">
                    <i class="bi bi-funnel-fill"></i> Paid
                </a>
            </th>
            <th>
                <a
                    asp-action="Index"
                    asp-route-pageNumber="@Model.PageNumber"
                    asp-route-pageSize="@Model.PageSize"
                    asp-route-sortBy="CreatedAt"
                    asp-route-sortOrder=@GetOrdering()
                    asp-route-searchBy="@Model.SearchBy"
                    asp-route-searchValue="@Model.SearchValue"
                    asp-route-status="@Model.Status"
                    class="link-underline text-decoration-none">
                    <i class="bi bi-funnel-fill"></i> Created At
                </a>
            </th>
            <th>
                <a
                    asp-action="Index"
                    asp-route-pageNumber="@Model.PageNumber"
                    asp-route-pageSize="@Model.PageSize"
                    asp-route-sortBy="UpdatedAt"
                    asp-route-sortOrder=@GetOrdering()
                    asp-route-searchBy="@Model.SearchBy"
                    asp-route-searchValue="@Model.SearchValue"
                    asp-route-status="@Model.Status"
                    class="link-underline text-decoration-none">
                    <i class="bi bi-funnel-fill"></i> Updated At
                </a>
            </th>
        </tr>
        </thead>
        <tbody>
        @foreach (var order in Model.Items)
        {
            <tr>
                <td>@order.Id</td>
                <td>@order.OrderNumber</td>
                <td>
                    <span class="badge @(order.Status switch {
                        OrderStatus.Processing => "bg-warning",
                        OrderStatus.Paid => "bg-success",
                        OrderStatus.Cancelled => "bg-danger",
                        OrderStatus.Failed => "bg-dark",
                        _ => "bg-secondary"
                    })">
                        @order.Status
                    </span>
                </td>
                <td>$@order.SubTotal.ToString("F2")</td>
                <td>$@order.Shipping.ToString("F2")</td>
                <td>$@order.Discount.ToString("F2")</td>
                <td>$@order.Total.ToString("F2")</td>
                <td>@order.Currency</td>
                <td>
                    @if (order.IsPaid)
                    {
                        <span class="badge bg-success">Yes</span>
                    }
                    else
                    {
                        <span class="badge bg-danger">No</span>
                    }
                </td>
                <td>@order.CreatedAt.ToString("yyyy-MM-dd HH:mm")</td>
                <td>
                    @if (order.UpdatedAt.HasValue)
                    {
                        @order.UpdatedAt.Value.ToString("yyyy-MM-dd HH:mm")
                    }
                    else
                    {
                        <span class="text-muted">-</span>
                    }
                </td>
            </tr>
        }
        </tbody>
    </table>
</div>

@await Html.PartialAsync("_PageNavigatorPartial");

@* Custom Pagination Script to Add Status Parameter *@
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const statusFilter = '@Model.Status';
        if (statusFilter) {
            const paginationLinks = document.querySelectorAll('.pagination a.page-link');
            paginationLinks.forEach(link => {
                const url = new URL(link.href);
                url.searchParams.set('status', statusFilter);
                link.href = url.toString();
            });
        }
    });
</script>

@section Styles {
    <style>
        .table-responsive .table th a {
            color: black;
            white-space: nowrap;
        }
        .table-responsive .table th a:hover {
            color: #3939a9;
        }
    </style>
}
