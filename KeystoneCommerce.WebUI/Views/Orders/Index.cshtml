@model OrderDashboardViewModel
@{
    Layout = "_AdminLayout";
    ViewData["Title"] = "Orders";
}

@functions {
    private string GetOrdering()
        => (Model.PaginatedOrders.SortOrder == Sorting.Ascending|| Model.PaginatedOrders.SortOrder == "") ? Sorting.Descending : Sorting.Ascending;
    
    private bool IsStatusSelected(int statusValue)
        => Model.PaginatedOrders.Status.HasValue && Model.PaginatedOrders.Status.Value == statusValue;
}

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="mb-4">Orders Dashboard</h1>
</div>

@* Analytics Widgets *@
<div class="row mb-4">
    @* Monthly Analytics Widget *@
    <div class="col-md-6 mb-3">
        <div class="card shadow-sm border-primary">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="bi bi-calendar-month"></i> Monthly Analytics
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <div class="border rounded p-3 bg-light">
                            <h6 class="text-muted mb-2">Total Orders</h6>
                            <h3 class="mb-0 text-primary">@Model.MonthlyAnalytics.OrderCount</h3>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="border rounded p-3 bg-light">
                            <h6 class="text-muted mb-2">Revenue</h6>
                            <h3 class="mb-0 text-success">$@Model.MonthlyAnalytics.OrdersRevenue.ToString("N2")</h3>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="border rounded p-3 bg-light">
                            <h6 class="text-muted mb-2">Pending Orders</h6>
                            <h3 class="mb-0 text-warning">@Model.MonthlyAnalytics.PendingOrdersCount</h3>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="border rounded p-3 bg-light">
                            <h6 class="text-muted mb-2">Average Order Value</h6>
                            <h3 class="mb-0 text-info">$@Model.MonthlyAnalytics.AverageOrderValue.ToString("N2")</h3>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="border rounded p-3 bg-light">
                            <h6 class="text-muted mb-2">Failed Orders</h6>
                            <h3 class="mb-0 text-dark">@Model.MonthlyAnalytics.FailedOrdersCount</h3>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="border rounded p-3 bg-light">
                            <h6 class="text-muted mb-2">Cancelled Orders</h6>
                            <h3 class="mb-0 text-danger">@Model.MonthlyAnalytics.CancellationOrdersCount</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @* Today Analytics Widget *@
    <div class="col-md-6 mb-3">
        <div class="card shadow-sm border-success">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="bi bi-calendar-day"></i> Today's Analytics
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <div class="border rounded p-3 bg-light">
                            <h6 class="text-muted mb-2">Total Orders</h6>
                            <h3 class="mb-0 text-primary">@Model.TodayAnalytics.OrderCount</h3>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="border rounded p-3 bg-light">
                            <h6 class="text-muted mb-2">Revenue</h6>
                            <h3 class="mb-0 text-success">$@Model.TodayAnalytics.OrdersRevenue.ToString("N2")</h3>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="border rounded p-3 bg-light">
                            <h6 class="text-muted mb-2">Pending Orders</h6>
                            <h3 class="mb-0 text-warning">@Model.TodayAnalytics.PendingOrdersCount</h3>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="border rounded p-3 bg-light">
                            <h6 class="text-muted mb-2">Average Order Value</h6>
                            <h3 class="mb-0 text-info">$@Model.TodayAnalytics.AverageOrderValue.ToString("N2")</h3>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="border rounded p-3 bg-light">
                            <h6 class="text-muted mb-2">Failed Orders</h6>
                            <h3 class="mb-0 text-dark">@Model.TodayAnalytics.FailedOrdersCount</h3>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="border rounded p-3 bg-light">
                            <h6 class="text-muted mb-2">Cancelled Orders</h6>
                            <h3 class="mb-0 text-danger">@Model.TodayAnalytics.CancellationOrdersCount</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@* Page Size Selector *@
@await Html.PartialAsync("_PageSizeSelectorPartial", model: @Model.PaginatedOrders.PageSize)

@* Filter and Search Form *@
<form method="get" asp-action="Index"
      class="d-flex justify-content-between align-items-center flex-wrap my-3">

    @* Status Filter - Left Side *@
    <div class="input-group input-group-md" style="width: auto">
        <label for="statusFilter" class="form-label me-2 mb-0 d-flex align-items-center">
            <i class="bi bi-funnel me-1"></i>
            <span class="fw-semibold">Filter by Status:</span>
        </label>
        <select id="statusFilter" name="status" class="form-select m-1"
                style="border-radius:20px; min-width: 150px;"
                onchange="this.form.submit()">
            <option value="">All Statuses</option>
            <option value="1" selected="@IsStatusSelected(1)">Processing</option>
            <option value="2" selected="@IsStatusSelected(2)">Paid</option>
            <option value="3" selected="@IsStatusSelected(3)">Cancelled</option>
            <option value="4" selected="@IsStatusSelected(4)">Failed</option>
        </select>
    </div>

    @* Search Form - Right Side *@
    <div class="input-group input-group-md" style="width: auto">
        <select asp-for="PaginatedOrders.SearchBy" class="form-select m-1"
                style="border-radius:20px; min-width: 150px;">
            <option value="Id">Id</option>
            <option value="OrderNumber">Order Number</option>
            <option value="SubTotal">Sub Total</option>
            <option value="Total">Total</option>
            <option value="Shipping">Shipping</option>
            <option value="Discount">Discount</option>
            <option value="Currency">Currency</option>
        </select>

        <input asp-for="PaginatedOrders.SearchValue" type="text" class="form-control me-1 rounded-pill m-1"
               placeholder="Search" style="min-width: 200px;">

        <button type="submit" class="btn btn-outline-success rounded-pill m-1">
            Search
        </button>
    </div>

    <!-- hidden fields -->
    <input type="hidden" name="pageNumber" value="1"/>
    <input type="hidden" name="pageSize" value="@Model.PaginatedOrders.PageSize"/>
    <input type="hidden" name="sortBy" value="@Model.PaginatedOrders.SortBy"/>
    <input type="hidden" name="sortOrder" value="@Model.PaginatedOrders.SortOrder"/>
</form>

<div class="table-responsive">
    <table class="table table-bordered table-hover">
        <thead class="table-light">
        <tr>
            <th>
                <a
                    asp-action="Index"
                    asp-route-pageNumber="@Model.PaginatedOrders.PageNumber"
                    asp-route-pageSize="@Model.PaginatedOrders.PageSize"
                    asp-route-sortBy="Id"
                    asp-route-sortOrder=@GetOrdering()
                    asp-route-searchBy="@Model.PaginatedOrders.SearchBy"
                    asp-route-searchValue="@Model.PaginatedOrders.SearchValue"
                    asp-route-status="@Model.PaginatedOrders.Status"
                    class="link-underline text-decoration-none">
                    <i class="bi bi-funnel-fill"></i> ID
                </a>
            </th>
            <th>
                <a
                    asp-action="Index"
                    asp-route-pageNumber="@Model.PaginatedOrders.PageNumber"
                    asp-route-pageSize="@Model.PaginatedOrders.PageSize"
                    asp-route-sortBy="OrderNumber"
                    asp-route-sortOrder=@GetOrdering()
                    asp-route-searchBy="@Model.PaginatedOrders.SearchBy"
                    asp-route-searchValue="@Model.PaginatedOrders.SearchValue"
                    asp-route-status="@Model.PaginatedOrders.Status"
                    class="link-underline text-decoration-none">
                    <i class="bi bi-funnel-fill"></i> Order Number
                </a>
            </th>
            <th>
                <a
                    asp-action="Index"
                    asp-route-pageNumber="@Model.PaginatedOrders.PageNumber"
                    asp-route-pageSize="@Model.PaginatedOrders.PageSize"
                    asp-route-sortBy="Status"
                    asp-route-sortOrder=@GetOrdering()
                    asp-route-searchBy="@Model.PaginatedOrders.SearchBy"
                    asp-route-searchValue="@Model.PaginatedOrders.SearchValue"
                    asp-route-status="@Model.PaginatedOrders.Status"
                    class="link-underline text-decoration-none">
                    <i class="bi bi-funnel-fill"></i> Status
                </a>
            </th>
            <th>
                <a
                    asp-action="Index"
                    asp-route-pageNumber="@Model.PaginatedOrders.PageNumber"
                    asp-route-pageSize="@Model.PaginatedOrders.PageSize"
                    asp-route-sortBy="SubTotal"
                    asp-route-sortOrder=@GetOrdering()
                    asp-route-searchBy="@Model.PaginatedOrders.SearchBy"
                    asp-route-searchValue="@Model.PaginatedOrders.SearchValue"
                    asp-route-status="@Model.PaginatedOrders.Status"
                    class="link-underline text-decoration-none">
                    <i class="bi bi-funnel-fill"></i> SubTotal
                </a>
            </th>
            <th>
                <a
                    asp-action="Index"
                    asp-route-pageNumber="@Model.PaginatedOrders.PageNumber"
                    asp-route-pageSize="@Model.PaginatedOrders.PageSize"
                    asp-route-sortBy="Shipping"
                    asp-route-sortOrder=@GetOrdering()
                    asp-route-searchBy="@Model.PaginatedOrders.SearchBy"
                    asp-route-searchValue="@Model.PaginatedOrders.SearchValue"
                    asp-route-status="@Model.PaginatedOrders.Status"
                    class="link-underline text-decoration-none">
                    <i class="bi bi-funnel-fill"></i> Shipping
                </a>
            </th>
            <th>
                <a
                    asp-action="Index"
                    asp-route-pageNumber="@Model.PaginatedOrders.PageNumber"
                    asp-route-pageSize="@Model.PaginatedOrders.PageSize"
                    asp-route-sortBy="Discount"
                    asp-route-sortOrder=@GetOrdering()
                    asp-route-searchBy="@Model.PaginatedOrders.SearchBy"
                    asp-route-searchValue="@Model.PaginatedOrders.SearchValue"
                    asp-route-status="@Model.PaginatedOrders.Status"
                    class="link-underline text-decoration-none">
                    <i class="bi bi-funnel-fill"></i> Discount
                </a>
            </th>
            <th>
                <a
                    asp-action="Index"
                    asp-route-pageNumber="@Model.PaginatedOrders.PageNumber"
                    asp-route-pageSize="@Model.PaginatedOrders.PageSize"
                    asp-route-sortBy="Total"
                    asp-route-sortOrder=@GetOrdering()
                    asp-route-searchBy="@Model.PaginatedOrders.SearchBy"
                    asp-route-searchValue="@Model.PaginatedOrders.SearchValue"
                    asp-route-status="@Model.PaginatedOrders.Status"
                    class="link-underline text-decoration-none">
                    <i class="bi bi-funnel-fill"></i> Total
                </a>
            </th>
            <th>
                <a
                    asp-action="Index"
                    asp-route-pageNumber="@Model.PaginatedOrders.PageNumber"
                    asp-route-pageSize="@Model.PaginatedOrders.PageSize"
                    asp-route-sortBy="Currency"
                    asp-route-sortOrder=@GetOrdering()
                    asp-route-searchBy="@Model.PaginatedOrders.SearchBy"
                    asp-route-searchValue="@Model.PaginatedOrders.SearchValue"
                    asp-route-status="@Model.PaginatedOrders.Status"
                    class="link-underline text-decoration-none">
                    <i class="bi bi-funnel-fill"></i> Currency
                </a>
            </th>
            <th>
                <a
                    asp-action="Index"
                    asp-route-pageNumber="@Model.PaginatedOrders.PageNumber"
                    asp-route-pageSize="@Model.PaginatedOrders.PageSize"
                    asp-route-sortBy="IsPaid"
                    asp-route-sortOrder=@GetOrdering()
                    asp-route-searchBy="@Model.PaginatedOrders.SearchBy"
                    asp-route-searchValue="@Model.PaginatedOrders.SearchValue"
                    asp-route-status="@Model.PaginatedOrders.Status"
                    class="link-underline text-decoration-none">
                    <i class="bi bi-funnel-fill"></i> Paid
                </a>
            </th>
            <th>
                <a
                    asp-action="Index"
                    asp-route-pageNumber="@Model.PaginatedOrders.PageNumber"
                    asp-route-pageSize="@Model.PaginatedOrders.PageSize"
                    asp-route-sortBy="CreatedAt"
                    asp-route-sortOrder=@GetOrdering()
                    asp-route-searchBy="@Model.PaginatedOrders.SearchBy"
                    asp-route-searchValue="@Model.PaginatedOrders.SearchValue"
                    asp-route-status="@Model.PaginatedOrders.Status"
                    class="link-underline text-decoration-none">
                    <i class="bi bi-funnel-fill"></i> Created At
                </a>
            </th>
            <th>
                <a
                    asp-action="Index"
                    asp-route-pageNumber="@Model.PaginatedOrders.PageNumber"
                    asp-route-pageSize="@Model.PaginatedOrders.PageSize"
                    asp-route-sortBy="UpdatedAt"
                    asp-route-sortOrder=@GetOrdering()
                    asp-route-searchBy="@Model.PaginatedOrders.SearchBy"
                    asp-route-searchValue="@Model.PaginatedOrders.SearchValue"
                    asp-route-status="@Model.PaginatedOrders.Status"
                    class="link-underline text-decoration-none">
                    <i class="bi bi-funnel-fill"></i> Updated At
                </a>
            </th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody>
        @foreach (var order in Model.PaginatedOrders.Items)
        {
            <tr>
                <td>@order.Id</td>
                <td>@order.OrderNumber</td>
                <td>
                    <span class="badge @(order.Status switch {
                        OrderStatus.Processing => "bg-warning",
                        OrderStatus.Paid => "bg-success",
                        OrderStatus.Cancelled => "bg-danger",
                        OrderStatus.Failed => "bg-dark",
                        _ => "bg-secondary"
                    })">
                        @order.Status
                    </span>
                </td>
                <td>$@order.SubTotal.ToString("F2")</td>
                <td>$@order.Shipping.ToString("F2")</td>
                <td>$@order.Discount.ToString("F2")</td>
                <td>$@order.Total.ToString("F2")</td>
                <td>@order.Currency</td>
                <td>
                    @if (order.IsPaid)
                    {
                        <span class="badge bg-success">Yes</span>
                    }
                    else
                    {
                        <span class="badge bg-danger">No</span>
                    }
                </td>
                <td>@order.CreatedAt.ToString("yyyy-MM-dd HH:mm")</td>
                <td>
                    @if (order.UpdatedAt.HasValue)
                    {
                        @order.UpdatedAt.Value.ToString("yyyy-MM-dd HH:mm")
                    }
                    else
                    {
                        <span class="text-muted">-</span>
                    }
                </td>
                <td>
                    <a asp-action="Details" asp-route-id="@order.Id" 
                       class="btn btn-sm btn-info" 
                       data-tippy="View Details" 
                       data-tippy-placement="top">
                        <i class="bi bi-eye"></i> Details
                    </a>
                </td>
            </tr>
        }
        </tbody>
    </table>
</div>

@await Html.PartialAsync("_PageNavigatorPartial", Model.PaginatedOrders);

@* Custom Pagination Script to Add Status Parameter *@
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const statusFilter = '@Model.PaginatedOrders.Status';
        if (statusFilter) {
            const paginationLinks = document.querySelectorAll('.pagination a.page-link');
            paginationLinks.forEach(link => {
                const url = new URL(link.href);
                url.searchParams.set('status', statusFilter);
                link.href = url.toString();
            });
        }
    });
</script>

@section Styles {
    <style>
        .table-responsive .table th a {
            color: black;
            white-space: nowrap;
        }
        .table-responsive .table th a:hover {
            color: #3939a9;
        }
        
        .card {
            transition: transform 0.2s;
        }
        
        .card:hover {
            transform: translateY(-2px);
        }
    </style>
}
